<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Returns Management</title>
    <link rel="icon" type="image/png" href="logo.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        /* 100% Wide & 80% Zoom Scaling */
        html { width: 100%; height: 100%; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            width: 125%; 
            height: 125%;
            transform: scale(0.8);
            transform-origin: top left;
            overflow-x: hidden; 
        }

        /* Custom Loader */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .tab-active { border-bottom: 3px solid #3b82f6; color: #3b82f6; font-weight: 700; background-color: #eff6ff; }
        .tab-inactive { color: #6b7280; }
        .tab-inactive:hover { color: #374151; background-color: #f9fafb; }
        
        /* Table Styling */
        .table-container { max-height: 600px; overflow-y: auto; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border-radius: 0.5rem; }
        thead th { position: sticky; top: 0; z-index: 10; background-color: #1f2937; color: white; }
        tbody tr:nth-child(even) { background-color: #f9fafb; }
        tbody tr:hover { background-color: #e5e7eb; }
    </style>
</head>
<body class="text-gray-800">

    <script>
        // ⚠️ DEPLOY NEW WEB APP & PASTE URL HERE
        const API_URL = "https://script.google.com/macros/s/AKfycbxBJblD5jbzoQBK7jXNMsxZIxgPFwrP52ZGr5pursK_BWc_AVoxDFR7Qsd4SNe9sLqsJw/exec"; 
    </script>

    <nav class="bg-white shadow-md border-b border-gray-200">
        <div class="w-full px-6 py-4">
            <div class="flex items-center">
                <i class="fa-solid fa-boxes-packing text-blue-600 text-2xl mr-3"></i>
                <h1 class="text-2xl font-bold text-gray-900 tracking-tight">Returns Management</h1>
            </div>
        </div>
    </nav>

    <div class="w-full px-6 py-6">
        
        <div class="flex border-b border-gray-200 mb-6 bg-white rounded-t-lg shadow-sm">
            <button id="tab-update" class="flex-1 py-4 text-center text-lg tab-active transition-all duration-200" onclick="switchTab('update')">Update Order</button>
            <button id="tab-view" class="flex-1 py-4 text-center text-lg tab-inactive transition-all duration-200" onclick="switchTab('view')">View Sheet Data</button>
        </div>

        <div id="global-loader" class="hidden flex justify-center py-6">
            <div class="loader"></div>
            <span class="ml-3 text-gray-600 font-medium self-center">Processing...</span>
        </div>

        <div id="status-msg" class="hidden mb-6 p-4 rounded-md text-base font-medium text-center shadow-sm"></div>

        <div id="section-update" class="space-y-6 max-w-5xl mx-auto">
            <div class="bg-white shadow-md rounded-lg p-8 border border-gray-100">
                <label class="block text-base font-semibold text-gray-700 mb-3">Search Order ID</label>
                <div class="flex gap-3">
                    <input type="text" id="orderIdInput" class="flex-1 block w-full rounded-md border-gray-300 shadow-sm text-base p-3 border" placeholder="Enter ID...">
                    <button onclick="searchOrder()" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-md font-bold shadow-sm">Search</button>
                </div>
            </div>

            <div id="result-card" class="hidden bg-white shadow-md rounded-lg p-8 border-t-4 border-blue-500">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8">
                    <div class="p-3 bg-gray-50 rounded-lg"><p class="text-xs text-gray-500 font-bold uppercase mb-1">Customer</p><p class="font-bold text-lg truncate" id="res-name">-</p></div>
                    <div class="p-3 bg-gray-50 rounded-lg"><p class="text-xs text-gray-500 font-bold uppercase mb-1">Phone</p><p class="font-bold text-lg" id="res-phone">-</p></div>
                    <div class="p-3 bg-gray-50 rounded-lg"><p class="text-xs text-gray-500 font-bold uppercase mb-1">Amount</p><p class="font-bold text-lg" id="res-amount">-</p></div>
                    <div class="p-3 bg-gray-50 rounded-lg"><p class="text-xs text-gray-500 font-bold uppercase mb-1">Current Status</p><p class="font-bold text-red-600 text-lg" id="res-status">-</p></div>
                </div>
                <hr class="border-gray-200 mb-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="space-y-5">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">New Status</label>
                            <select id="status-select" class="block w-full rounded-md border p-3 bg-white">
                                <option value="Returned">Returned</option>
                                <option value="Partial Delivery">Partial Delivery</option>
                                <option value="Delivered">Delivered</option>
                                <option value="Exchange">Exchange</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Save To (Destination)</label>
                            <select id="dest-sheet-select" class="block w-full rounded-md border p-3 bg-white"><option value="">Loading...</option></select>
                        </div>
                    </div>
                    <div class="space-y-5">
                        <div>
                            <div class="flex justify-between items-end mb-2">
                                <label class="block text-sm font-semibold text-gray-700">Void Amount</label>
                                <button onclick="copyAmount()" class="text-xs bg-blue-50 text-blue-700 px-2 py-1 rounded">Copy Order Amount</button>
                            </div>
                            <input type="number" id="void-amount" class="block w-full rounded-md border p-3" value="0">
                        </div>
                        <button onclick="updateStatus()" id="btn-save" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 mt-4 rounded-md shadow-md text-lg">Update & Save</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="section-view" class="hidden space-y-6 w-full">
            <div class="bg-white shadow-md rounded-lg p-6 border border-gray-100 grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                <div class="md:col-span-1">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Select Sheet</label>
                    <select id="view-sheet-select" class="block w-full rounded-md border p-3"><option value="">Select Sheet...</option></select>
                </div>
                <div class="md:col-span-1">
                     <label class="block text-sm font-medium text-gray-700 mb-2">Filter by Date (Optional)</label>
                     <div class="flex gap-2">
                         <input type="date" id="date-filter" class="block w-full rounded-md border p-3">
                         <button onclick="resetFilters()" class="bg-gray-200 hover:bg-gray-300 px-3 py-3 rounded-md"><i class="fa-solid fa-times"></i></button>
                     </div>
                </div>
                <div class="md:col-span-1">
                    <button onclick="initLoadData()" class="w-full bg-gray-800 hover:bg-gray-900 text-white px-6 py-3 rounded-md font-bold h-[50px]">
                        <i class="fa-solid fa-rotate mr-2"></i> Load Data
                    </button>
                </div>
            </div>

            <div id="stats-card" class="hidden bg-white shadow-md rounded-lg p-5 border-l-4 border-red-500 flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center">
                    <i class="fa-solid fa-calendar-day text-gray-400 text-xl mr-3"></i>
                    <div>
                        <span class="text-sm text-gray-500 font-bold uppercase tracking-wide">Showing Data:</span>
                        <div id="stats-date-label" class="text-lg font-semibold text-gray-900">Recent Records</div>
                    </div>
                </div>
                <div class="text-right">
                    <span class="block text-sm text-gray-500 font-bold uppercase tracking-wide">Total Void (Visible)</span>
                    <span id="void-total-display" class="text-3xl font-extrabold text-red-600">0</span>
                </div>
            </div>

            <div id="data-container" class="hidden bg-white shadow-lg rounded-lg overflow-hidden border border-gray-200">
                <div class="table-container">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-800 text-white">
                            <tr>
                                <th class="px-6 py-4 text-left text-xs font-bold uppercase tracking-wider">#</th>
                                <th class="px-6 py-4 text-left text-xs font-bold uppercase tracking-wider">Receive Date</th>
                                <th class="px-6 py-4 text-left text-xs font-bold uppercase tracking-wider">Order ID</th>
                                <th class="px-6 py-4 text-left text-xs font-bold uppercase tracking-wider">Name</th>
                                <th class="px-6 py-4 text-left text-xs font-bold uppercase tracking-wider">Number</th>
                                <th class="px-6 py-4 text-left text-xs font-bold uppercase tracking-wider">Amount</th>
                                <th class="px-6 py-4 text-left text-xs font-bold uppercase tracking-wider">Status</th>
                                <th class="px-6 py-4 text-left text-xs font-bold uppercase tracking-wider bg-red-900">Void Amount</th>
                            </tr>
                        </thead>
                        <tbody id="table-body" class="bg-white divide-y divide-gray-200 text-sm"></tbody>
                    </table>
                </div>
                <div id="load-more-container" class="hidden text-center py-4 bg-gray-50 border-t border-gray-200">
                    <button onclick="loadMoreData()" class="bg-white border border-gray-300 text-gray-700 hover:bg-gray-100 font-semibold py-2 px-6 rounded shadow-sm">
                        <i class="fa-solid fa-arrow-down mr-2"></i> Load More Data
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentOrder = null;
        let currentOffset = 0;
        let globalTotalVoid = 0;

        async function callApi(action, payload = {}) {
            payload.action = action;
            try {
                const response = await fetch(API_URL, {
                    method: "POST", mode: "cors", 
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify(payload)
                });
                return await response.json();
            } catch (error) { throw error; }
        }

        window.onload = function() { loadSheetNames(); };

        function switchTab(tab) {
            const updateSec = document.getElementById('section-update');
            const viewSec = document.getElementById('section-view');
            const tabUpdate = document.getElementById('tab-update');
            const tabView = document.getElementById('tab-view');
            if (tab === 'update') {
                updateSec.classList.remove('hidden'); viewSec.classList.add('hidden');
                tabUpdate.classList.add('tab-active'); tabView.classList.remove('tab-active');
                tabUpdate.classList.remove('tab-inactive'); tabView.classList.add('tab-inactive');
            } else {
                updateSec.classList.add('hidden'); viewSec.classList.remove('hidden');
                tabUpdate.classList.remove('tab-active'); tabView.classList.add('tab-active');
                tabUpdate.classList.add('tab-inactive'); tabView.classList.remove('tab-inactive');
            }
        }

        async function loadSheetNames() {
            try {
                const res = await callApi('getSheets');
                if(res.success) {
                    const opts = '<option value="">Select Sheet...</option>' + 
                        res.data.map(s => `<option value="${s.spreadsheetId}###${s.name}">${s.name}</option>`).join('');
                    document.getElementById('dest-sheet-select').innerHTML = opts;
                    document.getElementById('view-sheet-select').innerHTML = opts;
                }
            } catch(e) { showMsg("Failed to load sheets.", "error"); }
        }

        async function searchOrder() {
            const id = document.getElementById('orderIdInput').value;
            if(!id) return showMsg("Please enter an ID", "error");
            toggleLoader(true); document.getElementById('result-card').classList.add('hidden');
            try {
                const res = await callApi('search', { id: id });
                toggleLoader(false);
                if(res.success) {
                    currentOrder = res.data;
                    document.getElementById('res-name').innerText = currentOrder.name || '-';
                    document.getElementById('res-phone').innerText = currentOrder.phone || '-';
                    document.getElementById('res-amount').innerText = currentOrder.amount || '-';
                    document.getElementById('res-status').innerText = currentOrder.status || '-';
                    document.getElementById('result-card').classList.remove('hidden');
                    document.getElementById('status-select').value = 'Returned';
                    document.getElementById('void-amount').value = 0;
                } else { showMsg(res.message, "error"); }
            } catch(e) { toggleLoader(false); showMsg("Search Failed.", "error"); }
        }

        async function updateStatus() {
            if(!currentOrder) return;
            const destVal = document.getElementById('dest-sheet-select').value;
            if(!destVal) return showMsg("Select Destination Sheet", "error");
            const [destId, destName] = destVal.split('###');
            const payload = {
                sheetName: currentOrder.sheet, rowNum: currentOrder.rowNum,
                newStatus: document.getElementById('status-select').value,
                orderId: document.getElementById('orderIdInput').value,
                spreadsheetId: currentOrder.spreadsheetId,
                destinationSheetName: destName, destinationSpreadsheetId: destId,
                voidAmount: document.getElementById('void-amount').value,
                customerName: currentOrder.name, phone: currentOrder.phone, amount: currentOrder.amount
            };
            toggleLoader(true);
            try {
                const res = await callApi('update', payload);
                toggleLoader(false);
                if(res.success) {
                    showMsg(res.message, "success");
                    document.getElementById('res-status').innerText = payload.newStatus;
                } else { showMsg(res.message, "error"); }
            } catch(e) { toggleLoader(false); showMsg("Update Failed.", "error"); }
        }

        // --- View Data Logic ---

        // Initial Load (Reset)
        async function initLoadData() {
            currentOffset = 0; // Reset offset
            globalTotalVoid = 0; // Reset void total
            document.getElementById('table-body').innerHTML = '';
            document.getElementById('data-container').classList.add('hidden');
            document.getElementById('stats-card').classList.add('hidden');
            document.getElementById('load-more-container').classList.add('hidden');

            await fetchSheetData(false);
        }

        // Load More (Pagination)
        async function loadMoreData() {
            currentOffset += 50;
            await fetchSheetData(true);
        }

        // Core Fetch Function
        async function fetchSheetData(append) {
            const val = document.getElementById('view-sheet-select').value;
            if(!val) return showMsg("Select a sheet first", "error");
            const [destId, destName] = val.split('###');
            const dateInput = document.getElementById('date-filter').value;

            toggleLoader(true);
            
            try {
                const res = await callApi('getData', { 
                    spreadsheetId: destId, 
                    sheetName: destName, 
                    date: dateInput,
                    offset: currentOffset 
                });
                
                toggleLoader(false);

                if(res.success) {
                    renderTable(res.data, append);
                    
                    // Update Labels
                    const lbl = document.getElementById('stats-date-label');
                    if(res.filterApplied && dateInput) {
                        lbl.innerText = new Date(dateInput).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
                    } else {
                        lbl.innerText = "All Records (Newest First)";
                    }

                    document.getElementById('data-container').classList.remove('hidden');
                    document.getElementById('stats-card').classList.remove('hidden');

                    // Show/Hide Load More Button
                    const loadMoreBtn = document.getElementById('load-more-container');
                    if (res.hasMore && !res.filterApplied) {
                        loadMoreBtn.classList.remove('hidden');
                    } else {
                        loadMoreBtn.classList.add('hidden');
                    }

                } else { showMsg(res.message, "error"); }
            } catch(e) { toggleLoader(false); showMsg("Failed to load data.", "error"); }
        }

        function resetFilters() {
            document.getElementById('date-filter').value = '';
        }

        function renderTable(data, append) {
            const tbody = document.getElementById('table-body');
            
            if (!append) {
                // If not appending, clear existing
                tbody.innerHTML = ''; 
                globalTotalVoid = 0;
            }

            if(!data || data.length === 0) {
                if(!append) {
                   tbody.innerHTML = '<tr><td colspan="8" class="p-6 text-center text-gray-500">No Data Found</td></tr>';
                   document.getElementById('void-total-display').innerText = "0";
                }
                return;
            }

            // Calculate starting index for row numbers
            let startIndex = append ? tbody.children.length : 0;

            data.forEach((row, index) => {
                const tr = document.createElement('tr');
                const voidVal = parseFloat(row[6]) || 0;
                globalTotalVoid += voidVal;

                const td1 = document.createElement('td');
                td1.className = "px-6 py-4 whitespace-nowrap font-medium text-gray-500";
                // Continuous numbering
                td1.innerHTML = `<span class="bg-gray-200 text-gray-700 py-1 px-2 rounded text-xs">${startIndex + index + 1}</span>`;
                tr.appendChild(td1);

                [row[0], row[1], row[2], row[3], row[4]].forEach((txt, i) => {
                    const td = document.createElement('td');
                    td.className = `px-6 py-4 whitespace-nowrap text-gray-700 ${i===1?'font-bold text-gray-900':''}`;
                    td.innerText = txt || '-';
                    tr.appendChild(td);
                });

                const status = row[5] || '';
                let stClass = "text-gray-900";
                if(status === 'Returned') stClass = "text-red-600 font-bold bg-red-50 px-2 py-1 rounded";
                else if(status === 'Delivered') stClass = "text-green-600 font-bold bg-green-50 px-2 py-1 rounded";
                const tdS = document.createElement('td'); tdS.className="px-6 py-4 whitespace-nowrap";
                tdS.innerHTML = `<span class="${stClass}">${status}</span>`;
                tr.appendChild(tdS);

                const tdV = document.createElement('td');
                tdV.className = "px-6 py-4 whitespace-nowrap font-bold text-red-600 bg-red-50";
                tdV.innerText = row[6] || '-';
                tr.appendChild(tdV);

                tbody.appendChild(tr);
            });
            document.getElementById('void-total-display').innerText = globalTotalVoid.toLocaleString();
        }

        function copyAmount() { if(currentOrder) document.getElementById('void-amount').value = currentOrder.amount; }
        function toggleLoader(s) { document.getElementById('global-loader').classList.toggle('hidden', !s); }
        function showMsg(m, t) {
            const el = document.getElementById('status-msg');
            el.innerText = m; el.className = `hidden mb-6 p-4 rounded-md text-base font-medium text-center shadow-sm ${t==='success'?'bg-green-100 text-green-800':'bg-red-100 text-red-800'}`;
            el.classList.remove('hidden'); setTimeout(()=>el.classList.add('hidden'),5000);
        }
    </script>
</body>
</html>
